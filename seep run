-- SERVICES
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RS = game:GetService("RunService")
local player = Players.LocalPlayer

-- CONFIG
local UI_COLOR = Color3.fromRGB(30,30,30)
local ACCENT = Color3.fromRGB(0,170,255)
local TEXT = Color3.fromRGB(255,255,255)

-- FLY VARIABLES
local flying = false
local flySpeed = 50 
local bg, bv

-- NOCLIP VARIABLES
local nocliping = false

-- GUI SETUP
local gui = Instance.new("ScreenGui")
gui.Name = "HVK9_Menu_Fixed_Noclip"
if player.PlayerGui:FindFirstChild("HVK9_Menu_Fixed_Noclip") then
	player.PlayerGui.HVK9_Menu_Fixed_Noclip:Destroy()
end
gui.Parent = player.PlayerGui
gui.ResetOnSpawn = false

-- === MAIN FRAME ===
local main = Instance.new("Frame", gui)
main.Name = "MainFrame"
main.Size = UDim2.new(0,330,0,440) 
main.Position = UDim2.new(0.5,-165,0.5,-220) 
main.BackgroundColor3 = UI_COLOR
main.Active = true
main.Draggable = true 
main.Visible = true
Instance.new("UICorner", main).CornerRadius = UDim.new(0,12)

-- === OPEN BUTTON ===
local openBtn = Instance.new("TextButton", gui)
openBtn.Name = "OpenButton"
openBtn.Size = UDim2.new(0,50,0,50)
openBtn.Position = UDim2.new(0, 20, 0.5, -25) 
openBtn.BackgroundColor3 = UI_COLOR
openBtn.Text = "H"
openBtn.TextColor3 = ACCENT
openBtn.Font = Enum.Font.GothamBold
openBtn.TextSize = 30
openBtn.Active = true
openBtn.Draggable = true 
openBtn.Visible = false
Instance.new("UICorner", openBtn).CornerRadius = UDim.new(0,12)
local stroke = Instance.new("UIStroke", openBtn)
stroke.Color = ACCENT
stroke.Thickness = 2
stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

-- === MINIMIZE BUTTON ===
local minBtn = Instance.new("TextButton", main)
minBtn.Name = "MinButton"
minBtn.Size = UDim2.new(0, 40, 0, 40)
minBtn.Position = UDim2.new(1, -45, 0, 5) 
minBtn.BackgroundTransparency = 1
minBtn.Text = "-"
minBtn.TextColor3 = TEXT
minBtn.Font = Enum.Font.GothamBold
minBtn.TextSize = 35

minBtn.MouseButton1Click:Connect(function()
	main.Visible = false
	openBtn.Visible = true
end)

openBtn.MouseButton1Click:Connect(function()
	openBtn.Visible = false
	main.Visible = true
end)

-- TITLE
local title = Instance.new("TextLabel", main)
title.Text = "HVK9"
title.Size = UDim2.new(1,0,0,45)
title.BackgroundTransparency = 1
title.TextColor3 = TEXT
title.Font = Enum.Font.GothamBold
title.TextSize = 20

-- CONTAINER
local container = Instance.new("Frame", main)
container.Position = UDim2.new(0,15,0,55)
container.Size = UDim2.new(1,-30,1,-65)
container.BackgroundTransparency = 1

local layout = Instance.new("UIListLayout", container)
layout.Padding = UDim.new(0,12) 
layout.FillDirection = Enum.FillDirection.Vertical
layout.HorizontalAlignment = Enum.HorizontalAlignment.Left

-- === FEATURE FUNCTION (LOGIC BẬT/TẮT CHUẨN) ===
local function createFeature(name, min, max, default, callback)
	local frame = Instance.new("Frame", container)
	frame.Size = UDim2.new(1,0,0,85) 
	frame.BackgroundTransparency = 1

	local label = Instance.new("TextLabel", frame)
	label.Text = name
	label.Size = UDim2.new(1,-70,0,25)
	label.BackgroundTransparency = 1
	label.TextColor3 = TEXT
	label.Font = Enum.Font.GothamBold
	label.TextSize = 15
	label.TextXAlignment = Enum.TextXAlignment.Left

	local value = Instance.new("TextLabel", frame)
	value.Size = UDim2.new(0,60,0,25)
	value.Position = UDim2.new(1,-60,0,0)
	value.BackgroundTransparency = 1
	value.TextColor3 = ACCENT
	value.Text = tostring(default)
	value.Font = Enum.Font.GothamBold
	value.TextSize = 15

	local bar = Instance.new("TextButton", frame)
	bar.Size = UDim2.new(1,-60,0,32)
	bar.Position = UDim2.new(0,0,0,35) 
	bar.BackgroundColor3 = Color3.fromRGB(60,60,60)
	bar.Text = ""
	bar.AutoButtonColor = false
	Instance.new("UICorner", bar).CornerRadius = UDim.new(0,8)

	local fill = Instance.new("Frame", bar)
	fill.BackgroundColor3 = ACCENT
	fill.BorderSizePixel = 0
	Instance.new("UICorner", fill).CornerRadius = UDim.new(0,8)

	local toggle = Instance.new("TextButton", frame)
	toggle.Size = UDim2.new(0,40,0,22)
	toggle.Position = UDim2.new(1,-45,0,43) 
	toggle.BackgroundColor3 = Color3.fromRGB(70,70,70)
	toggle.Text = ""
	Instance.new("UICorner", toggle).CornerRadius = UDim.new(1,0)

	local current = default
	local active = false
	
	local percent = (default - min) / (max - min)
	fill.Size = UDim2.new(percent, 0, 1, 0)

	local dragging = false
	local function update(input)
		local p = math.clamp((input.Position.X - bar.AbsolutePosition.X) / bar.AbsoluteSize.X, 0, 1)
		fill.Size = UDim2.new(p, 0, 1, 0)
		current = math.floor(min + (max - min) * p)
		value.Text = tostring(current)
		
        if active then
		    callback("VALUE", current)
        end
	end

	bar.InputBegan:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.Touch or i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			update(i)
		end
	end)

	UIS.InputChanged:Connect(function(i)
		if dragging and (i.UserInputType == Enum.UserInputType.Touch or i.UserInputType == Enum.UserInputType.MouseMovement) then
			update(i)
		end
	end)

	UIS.InputEnded:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.Touch or i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)

	toggle.MouseButton1Click:Connect(function()
		active = not active
		toggle.BackgroundColor3 = active and ACCENT or Color3.fromRGB(70,70,70)
        
        if active then
            callback("VALUE", current) 
            callback("TOGGLE", true) 
        else
            callback("TOGGLE", false)
        end
	end)
end

local function createToggleFeature(name, callback)
    local frame = Instance.new("Frame", container)
	frame.Size = UDim2.new(1,0,0,50) 
	frame.BackgroundTransparency = 1

	local label = Instance.new("TextLabel", frame)
	label.Text = name
	label.Size = UDim2.new(1,-70,0,25)
	label.BackgroundTransparency = 1
	label.TextColor3 = TEXT
	label.Font = Enum.Font.GothamBold
	label.TextSize = 15
	label.TextXAlignment = Enum.TextXAlignment.Left
    
	local toggle = Instance.new("TextButton", frame)
	toggle.Size = UDim2.new(0,50,0,30)
	toggle.Position = UDim2.new(1,-60,0.5,-15) 
	toggle.BackgroundColor3 = Color3.fromRGB(70,70,70)
	toggle.Text = ""
    toggle.TextSize = 0
	Instance.new("UICorner", toggle).CornerRadius = UDim.new(1,0)

	local active = false
	toggle.MouseButton1Click:Connect(function()
		active = not active
		toggle.BackgroundColor3 = active and ACCENT or Color3.fromRGB(70,70,70)
		callback(active)
	end)
end

-- --- DEFINITIONS ---

-- SPEED
createFeature("Speed", 16, 250, 16, function(mode, val)
	local char = player.Character
	local h = char and char:FindFirstChild("Humanoid")
	if not h then return end

	if mode == "VALUE" then 
        h.WalkSpeed = val
    elseif mode == "TOGGLE" and val == false then
        h.WalkSpeed = 16 
	end
end)

-- JUMP
createFeature("Jump", 50, 300, 50, function(mode, val)
	local char = player.Character
	local h = char and char:FindFirstChild("Humanoid")
	if not h then return end
    
	if mode == "VALUE" then 
        h.UseJumpPower = true
        h.JumpPower = val
    elseif mode == "TOGGLE" and val == false then
        h.JumpPower = 50 
	end
end)

-- FLY
local function startFly()
	local c = player.Character
	if not c then return end
	local hrp = c:FindFirstChild("HumanoidRootPart")
	local h = c:FindFirstChild("Humanoid")
	if not hrp or not h then return end

	h.AutoRotate = false
	h.PlatformStand = true -- Fly thì tắt vật lý chân

	if bg then bg:Destroy() end
	if bv then bv:Destroy() end

	bg = Instance.new("BodyGyro", hrp)
	bg.MaxTorque = Vector3.new(9e9,9e9,9e9)
	bg.P = 9e4
	bg.CFrame = workspace.CurrentCamera.CFrame

	bv = Instance.new("BodyVelocity", hrp)
	bv.MaxForce = Vector3.new(9e9,9e9,9e9)
	bv.Velocity = Vector3.zero
	
	flying = true
end

local function stopFly()
	flying = false
	if bg then bg:Destroy() bg = nil end
	if bv then bv:Destroy() bv = nil end
	
	local c = player.Character
	local h = c and c:FindFirstChild("Humanoid")
	if h then 
		h.PlatformStand = false 
		h.AutoRotate = true
	end
end

createFeature("Fly Speed", 0, 300, 50, function(mode, val)
    if mode == "VALUE" then
        flySpeed = val
    elseif mode == "TOGGLE" then
        if val then startFly() else stopFly() end
    end
end)

-- LOGIC FLY (Chỉ xử lý bay)
RS.RenderStepped:Connect(function()
	if not flying then return end
	local c = player.Character
	local hrp = c and c:FindFirstChild("HumanoidRootPart")
	local h = c and c:FindFirstChild("Humanoid")
	if not hrp or not h then return end

	local cam = workspace.CurrentCamera
	if bg then bg.CFrame = cam.CFrame end

	local m = h.MoveDirection
	
	if bv and hrp then
		if m.Magnitude == 0 then
			bv.Velocity = Vector3.zero
		else
			local localMove = cam.CFrame:VectorToObjectSpace(m)
			bv.Velocity = (cam.CFrame.LookVector * -localMove.Z + cam.CFrame.RightVector * localMove.X) * flySpeed
		end
	end
end)

-- === NOCLIP MỚI (DÙNG CANCOLLIDE = FALSE) ===
-- Logic này hoạt động hoàn hảo với Speed cao
RS.Stepped:Connect(function()
	if nocliping then
		if player.Character then
			for _, part in pairs(player.Character:GetDescendants()) do
				if part:IsA("BasePart") and part.CanCollide == true then
					part.CanCollide = false
				end
			end
		end
	end
end)

createToggleFeature("Noclip (Wall)", function(active)
	nocliping = active
end)

player.CharacterAdded:Connect(function(char)
	char:WaitForChild("HumanoidRootPart")
	-- Reset biến nếu cần thiết, hoặc để người dùng tự bật lại
end)
