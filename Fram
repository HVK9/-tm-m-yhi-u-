--[[
    ULTIMATE HYBRID V14: NO LAG & SMART BRING
    - Fix Lag: Loại bỏ Deep Scan, chỉ quét thông minh vùng chứa quái.
    - Fix Gom Quái: Player bay trên cao, quái bị đè xuống đất dưới chân.
    - Filter: Lọc tuyệt đối NPC rác (Shop, Quest, Guide...).
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- --- HỆ THỐNG NET (ANTI-ERROR) ---
local Net = ReplicatedStorage:FindFirstChild("Modules") and ReplicatedStorage.Modules:FindFirstChild("Net")
-- Nếu không tìm thấy đúng đường dẫn, thử tìm đệ quy nhẹ
if not Net then 
    for _, v in pairs(ReplicatedStorage:GetDescendants()) do
        if v.Name == "Net" and v:IsA("Folder") then Net = v; break end
    end
end

local RegisterAttack = Net and (Net:FindFirstChild("RE/RegisterAttack") or Net:FindFirstChild("RegisterAttack"))
local RegisterHit = Net and (Net:FindFirstChild("RE/RegisterHit") or Net:FindFirstChild("RegisterHit"))

-- --- CẤU HÌNH ---
local CONFIG = {
    AutoFarm = false, -- Gom chung Teleport + Bring + Attack vào 1 nút cho tiện
    SelectedMob = nil,
    Height = 25, -- Độ cao mặc định (Player sẽ bay cao hơn quái 25 stud)
    DistFromPlayer = 15, -- Quái sẽ bị gom cách chân player 15 stud (để không bị bug vào người)
    RefreshRate = 3, -- Quét chậm lại (3 giây/lần) để GIẢM LAG tối đa
    AttackRange = 350, -- Tầm đánh
    
    -- Danh sách đen (NPC không được đánh)
    Blacklist = {
        "Quest", "Shop", "Store", "Guide", "Nurse", "Doctor", "Sailor", 
        "Blacksmith", "Dealer", "Giver", "Dummy", "Training"
    }
}

if _G.UltimateHybridUI then _G.UltimateHybridUI:Destroy() end

-- --- HÀM TỐI ƯU ---

-- 1. Tìm Folder chứa quái (Giúp không phải quét cả map)
local EnemyFolder = nil
local function UpdateEnemyFolder()
    local names = {"Enemies", "Mobs", "Monsters", "NPCs", "Live"}
    for _, n in pairs(names) do
        if Workspace:FindFirstChild(n) then EnemyFolder = Workspace[n]; return end
    end
    EnemyFolder = Workspace -- Nếu không có folder riêng thì quét tất cả
end
UpdateEnemyFolder()

-- 2. Kiểm tra có phải quái đánh được không
local function IsValidMob(v)
    if not v or not v.Parent then return false end
    if v.Name == LocalPlayer.Name then return false end -- Không đánh bản thân
    
    local hum = v:FindFirstChild("Humanoid")
    local root = v:FindFirstChild("HumanoidRootPart")
    
    if hum and root and hum.Health > 0 then
        -- Lọc NPC qua tên
        local n = v.Name:lower()
        for _, bad in pairs(CONFIG.Blacklist) do
            if string.find(n, bad:lower()) then return false end
        end
        -- Lọc Player khác
        if Players:GetPlayerFromCharacter(v) then return false end
        
        return true
    end
    return false
end

-- --- GIAO DIỆN UI (CHỐNG TRÀN) ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "UltimateHybridUI"
pcall(function() ScreenGui.Parent = CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer.PlayerGui end
_G.UltimateHybridUI = ScreenGui

local Main = Instance.new("Frame", ScreenGui)
Main.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
Main.Position = UDim2.new(0.05, 0, 0.2, 0)
Main.Size = UDim2.new(0, 280, 0, 400)
Main.BorderSizePixel = 0
Instance.new("UICorner", Main, UDim.new(0, 6))

-- Header
local Header = Instance.new("Frame", Main)
Header.BackgroundColor3 = Color3.fromRGB(45, 50, 60)
Header.Size = UDim2.new(1, 0, 0, 35)
Instance.new("UICorner", Header, UDim.new(0, 6))
local Title = Instance.new("TextLabel", Header)
Title.Text = "AUTO FARM V14 - NO LAG"
Title.Size = UDim2.new(1,0,1,0); Title.BackgroundTransparency=1; Title.Font=Enum.Font.GothamBlack; Title.TextColor3=Color3.new(1,1,1); Title.TextSize=14

-- Control Area
local Controls = Instance.new("Frame", Main)
Controls.BackgroundTransparency=1; Controls.Position=UDim2.new(0,0,0,40); Controls.Size=UDim2.new(1,0,0,120)
local UIList = Instance.new("UIListLayout", Controls); UIList.HorizontalAlignment=Enum.HorizontalAlignment.Center; UIList.Padding=UDim.new(0,8)

local function MakeBtn(text, col, cb)
    local b = Instance.new("TextButton", Controls)
    b.Size = UDim2.new(0.9,0,0,40); b.BackgroundColor3=col; b.Text=text; b.TextColor3=Color3.new(1,1,1); b.Font=Enum.Font.GothamBold; Instance.new("UICorner", b)
    b.MouseButton1Click:Connect(function() cb(b) end)
    return b
end

-- Nút Auto Farm (Gộp tất cả)
MakeBtn("AUTO FARM: OFF", Color3.fromRGB(200, 50, 50), function(b)
    if not CONFIG.SelectedMob then b.Text="CHỌN QUÁI TRƯỚC!"; task.wait(1); b.Text="AUTO FARM: OFF"; return end
    CONFIG.AutoFarm = not CONFIG.AutoFarm
    b.Text = CONFIG.AutoFarm and "AUTO FARM: ON ["..CONFIG.SelectedMob.."]" or "AUTO FARM: OFF"
    b.BackgroundColor3 = CONFIG.AutoFarm and Color3.fromRGB(50, 200, 100) or Color3.fromRGB(200, 50, 50)
end)

-- Slider chỉnh độ cao
local HFrame = Instance.new("Frame", Controls); HFrame.Size=UDim2.new(0.9,0,0,30); HFrame.BackgroundColor3=Color3.fromRGB(35,35,45); Instance.new("UICorner", HFrame)
local HLbl = Instance.new("TextLabel", HFrame); HLbl.Size=UDim2.new(1,0,1,0); HLbl.BackgroundTransparency=1; HLbl.Text="Độ cao bay: "..CONFIG.Height; HLbl.TextColor3=Color3.new(1,1,1); HLbl.Font=Enum.Font.GothamBold
local HBtn = Instance.new("TextButton", HFrame); HBtn.Size=UDim2.new(1,0,1,0); HBtn.BackgroundTransparency=1; HBtn.Text=""
HBtn.MouseButton1Click:Connect(function() 
    CONFIG.Height = (CONFIG.Height >= 50) and 10 or (CONFIG.Height + 10)
    HLbl.Text = "Độ cao bay: " .. CONFIG.Height 
end)

-- Danh sách mob (Scrolling)
local Scroll = Instance.new("ScrollingFrame", Main)
Scroll.Position=UDim2.new(0,0,0,170); Scroll.Size=UDim2.new(1,0,1,-175); Scroll.BackgroundTransparency=1; Scroll.ScrollBarThickness=3
local SList = Instance.new("UIListLayout", Scroll); SList.HorizontalAlignment=Enum.HorizontalAlignment.Center; SList.Padding=UDim.new(0,2)
SList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function() Scroll.CanvasSize = UDim2.new(0,0,0,SList.AbsoluteContentSize.Y+10) end)

-- --- LOGIC CỐT LÕI ---

local function RefreshList()
    local mobs = {}
    -- Quét nhẹ nhàng
    local items = EnemyFolder:GetChildren()
    for _, v in ipairs(items) do
        if IsValidMob(v) then
            mobs[v.Name] = (mobs[v.Name] or 0) + 1
        end
    end
    
    for _,c in pairs(Scroll:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
    
    -- Sắp xếp theo tên
    local sortedNames = {}
    for n in pairs(mobs) do table.insert(sortedNames, n) end
    table.sort(sortedNames)

    for _, name in ipairs(sortedNames) do
        local count = mobs[name]
        local b = Instance.new("TextButton", Scroll)
        b.Size = UDim2.new(0.9,0,0,25); b.BackgroundColor3 = (CONFIG.SelectedMob == name) and Color3.fromRGB(0,120,215) or Color3.fromRGB(40,40,50)
        b.Text = name .. " [" .. count .. "]"; b.TextColor3 = Color3.new(1,1,1); b.Font = Enum.Font.Gotham; b.TextSize=12; Instance.new("UICorner", b)
        b.MouseButton1Click:Connect(function() CONFIG.SelectedMob = name; RefreshList() end)
    end
end

-- Loop Auto Farm
RunService.Stepped:Connect(function()
    if CONFIG.AutoFarm and CONFIG.SelectedMob then
        local p = LocalPlayer.Character
        if not p or not p:FindFirstChild("HumanoidRootPart") then return end
        
        local myRoot = p.HumanoidRootPart
        
        -- 1. Tìm mục tiêu chính (Con gần nhất) để bay tới
        local mainTarget = nil
        local minDist = math.huge
        local allTargets = {} -- Danh sách tất cả quái cùng tên để gom
        
        for _, v in ipairs(EnemyFolder:GetChildren()) do
            if v.Name == CONFIG.SelectedMob and IsValidMob(v) then
                table.insert(allTargets, v)
                local d = (myRoot.Position - v.HumanoidRootPart.Position).Magnitude
                if d < minDist then minDist = d; mainTarget = v end
            end
        end
        
        -- 2. Xử lý vị trí & Gom quái
        if mainTarget then
            -- A. GIỮ NGƯỜI CHƠI TRÊN CAO (Vị trí quái + Height)
            local safePos = mainTarget.HumanoidRootPart.Position + Vector3.new(0, CONFIG.Height, 0)
            myRoot.CFrame = CFrame.new(safePos, mainTarget.HumanoidRootPart.Position) -- Nhìn xuống quái
            myRoot.Velocity = Vector3.new(0,0,0) -- Chống rơi
            
            -- B. GOM QUÁI (BRING) XUỐNG DƯỚI CHÂN
            -- Vị trí "nhốt" quái: Dưới chân nhân vật (cách CONFIG.DistFromPlayer)
            local trapPos = myRoot.Position - Vector3.new(0, CONFIG.DistFromPlayer, 0)
            
            for _, mob in ipairs(allTargets) do
                local mRoot = mob:FindFirstChild("HumanoidRootPart")
                if mRoot then
                    -- Dịch chuyển quái vào rọ
                    mRoot.CFrame = CFrame.new(trapPos)
                    mRoot.CanCollide = false -- Tắt va chạm để chúng lồng vào nhau, dễ đánh aoe
                    mRoot.Velocity = Vector3.new(0,0,0) -- Khóa chuyển động quái
                    
                    -- Xoay quái cho đẹp (tùy chọn)
                    -- mRoot.CFrame = CFrame.lookAt(trapPos, myRoot.Position)
                end
            end
            
            -- C. TỰ ĐỘNG ĐÁNH (ATTACK)
            if RegisterAttack and RegisterHit then
                RegisterAttack:FireServer()
                for _, mob in ipairs(allTargets) do
                    local mRoot = mob:FindFirstChild("HumanoidRootPart")
                    if mRoot and (mRoot.Position - myRoot.Position).Magnitude < CONFIG.AttackRange then
                         RegisterHit:FireServer(mRoot)
                    end
                end
            end
        end
    end
end)

-- Loop Refresh UI (Chậm để đỡ lag)
task.spawn(function()
    while task.wait(CONFIG.RefreshRate) do
        if _G.UltimateHybridUI then RefreshList() end
    end
end)

-- Drag UI
local dragging, dragStart, startPos
Header.InputBegan:Connect(function(input) if input.UserInputType==Enum.UserInputType.MouseButton1 then dragging=true; dragStart=input.Position; startPos=Main.Position end end)
UserInputService.InputChanged:Connect(function(input) if dragging and input.UserInputType==Enum.UserInputType.MouseMovement then local delta=input.Position-dragStart; Main.Position=UDim2.new(startPos.X.Scale,startPos.X.Offset+delta.X,startPos.Y.Scale,startPos.Y.Offset+delta.Y) end end)
UserInputService.InputEnded:Connect(function(input) if input.UserInputType==Enum.UserInputType.MouseButton1 then dragging=false end end)
