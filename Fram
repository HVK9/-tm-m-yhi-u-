--[[
    ULTIMATE HYBRID V13: DEEP SCAN & BRING ALL
    - Global Scan: Quét toàn bộ Workspace và ReplicatedStorage để tìm Data quái.
    - Bring & Hit All: Gom quái và đánh tất cả mục tiêu cùng lúc.
    - Anti-Overflow UI: Giữ nguyên giao diện không bị tràn.
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Net = ReplicatedStorage:WaitForChild("Modules", 5) and ReplicatedStorage.Modules:WaitForChild("Net", 5)
-- Fallback an toàn
if not Net then 
    -- Thử tìm Net ở chỗ khác hoặc bỏ qua nếu game không dùng Net
    Net = ReplicatedStorage:FindFirstChild("Net", true)
end

local RegisterAttack = Net and (Net:FindFirstChild("RE/RegisterAttack") or Net:FindFirstChild("RegisterAttack"))
local RegisterHit = Net and (Net:FindFirstChild("RE/RegisterHit") or Net:FindFirstChild("RegisterHit"))

-- --- CẤU HÌNH ---
local CONFIG = {
    IsTeleporting = false,
    BringEnabled = false, -- Chế độ Gom/Hit All
    SelectedMob = nil,
    Offsets = {X = 0, Y = 12, Z = 0},
    RefreshRate = 2, -- Quét chậm lại chút vì quét sâu tốn tài nguyên
    AttackEnabled = false,
    AttackRange = 5000, -- Tăng tầm đánh lên cực đại để bao trọn map
    HitDelay = 0.0, -- Spam cực nhanh cho chế độ Hit All
    NPC_Blacklist = {"Quest", "Shop", "Nurse", "Sailor", "Blacksmith", "Doctor", "Guide", "Dummy"}
}

if _G.UltimateHybridUI then _G.UltimateHybridUI:Destroy() end

-- --- HÀM QUÉT SÂU (DEEP SCAN) ---
local function IsAttackable(v)
    if not v:IsA("Model") then return false end
    if v == LocalPlayer.Character then return false end
    if Players:GetPlayerFromCharacter(v) then return false end
    
    local hum = v:FindFirstChildOfClass("Humanoid")
    -- Ở chế độ quét data, ta chấp nhận cả quái chưa có RootPart (chưa spawn hẳn) để hiện tên
    if hum then
        local nameLower = v.Name:lower()
        for _, bName in pairs(CONFIG.NPC_Blacklist) do
            if string.find(nameLower, bName:lower()) then return false end
        end
        return true
    end
    return false
end

-- --- GIAO DIỆN UI ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "UltimateHybridUI"
pcall(function() ScreenGui.Parent = CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer.PlayerGui end
_G.UltimateHybridUI = ScreenGui

local Main = Instance.new("Frame")
Main.Parent = ScreenGui
Main.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
Main.Position = UDim2.new(0.05, 0, 0.2, 0)
Main.Size = UDim2.new(0, 320, 0, 480)
Main.BorderSizePixel = 0
Instance.new("UICorner", Main)

local Title = Instance.new("Frame")
Title.Parent = Main
Title.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
Title.Size = UDim2.new(1, 0, 0, 40)
local TitleText = Instance.new("TextLabel")
TitleText.Parent = Title
TitleText.BackgroundTransparency = 1; TitleText.Size = UDim2.new(1, -10, 1, 0); TitleText.Position = UDim2.new(0, 10, 0, 0)
TitleText.Font = Enum.Font.GothamBlack; TitleText.Text = "AUTO FARM V13: GLOBAL & BRING"; TitleText.TextColor3 = Color3.new(1,1,1); TitleText.TextSize = 13; TitleText.TextXAlignment = Enum.TextXAlignment.Left

-- KHU VỰC ĐIỀU KHIỂN
local ControlArea = Instance.new("Frame")
ControlArea.Parent = Main; ControlArea.BackgroundTransparency = 1; ControlArea.Position = UDim2.new(0,0,0,45); ControlArea.Size = UDim2.new(1,0,0,200)
local CLayout = Instance.new("UIListLayout", ControlArea); CLayout.Padding = UDim.new(0,5); CLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

local function CreateBtn(txt, col, func)
    local b = Instance.new("TextButton"); b.Parent = ControlArea; b.Size = UDim2.new(0.95,0,0,40); b.BackgroundColor3 = col; b.Text = txt; b.TextColor3 = Color3.new(1,1,1); b.Font = Enum.Font.GothamBold; b.TextSize = 12; Instance.new("UICorner", b)
    b.MouseButton1Click:Connect(function() func(b) end)
    return b
end

-- 1. Nút Auto Attack
CreateBtn("AUTO ATTACK: OFF", Color3.fromRGB(60,60,70), function(b)
    CONFIG.AttackEnabled = not CONFIG.AttackEnabled
    b.Text = CONFIG.AttackEnabled and "AUTO ATTACK: ON (SPAM)" or "AUTO ATTACK: OFF"
    b.BackgroundColor3 = CONFIG.AttackEnabled and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(60,60,70)
end)

-- 2. Nút Teleport
CreateBtn("TELEPORT: OFF", Color3.fromRGB(60,60,70), function(b)
    if not CONFIG.SelectedMob then b.Text = "CHỌN QUÁI TRƯỚC!"; task.wait(1); b.Text = "TELEPORT: OFF"; return end
    CONFIG.IsTeleporting = not CONFIG.IsTeleporting
    b.Text = CONFIG.IsTeleporting and "STOP TELEPORT" or "TELEPORT: OFF"
    b.BackgroundColor3 = CONFIG.IsTeleporting and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(60,60,70)
end)

-- 3. Nút BRING / GOM QUÁI (Mới)
CreateBtn("GOM & HIT ALL: OFF", Color3.fromRGB(100, 50, 0), function(b)
    if not CONFIG.SelectedMob then b.Text = "CHỌN QUÁI TRƯỚC!"; task.wait(1); b.Text = "GOM & HIT ALL: OFF"; return end
    CONFIG.BringEnabled = not CONFIG.BringEnabled
    b.Text = CONFIG.BringEnabled and "GOM & HIT ALL: ON" or "GOM & HIT ALL: OFF"
    b.BackgroundColor3 = CONFIG.BringEnabled and Color3.fromRGB(255, 100, 0) or Color3.fromRGB(100, 50, 0)
end)

-- Slider Y
local YFrame = Instance.new("Frame", ControlArea); YFrame.Size = UDim2.new(0.95,0,0,40); YFrame.BackgroundColor3 = Color3.fromRGB(30,30,40); Instance.new("UICorner", YFrame)
local YLbl = Instance.new("TextLabel", YFrame); YLbl.Size = UDim2.new(1,0,1,0); YLbl.BackgroundTransparency=1; YLbl.Text = "Độ cao: "..CONFIG.Offsets.Y; YLbl.TextColor3 = Color3.new(1,1,1); YLbl.Font = Enum.Font.GothamBold
local YBtn = Instance.new("TextButton", YFrame); YBtn.Size = UDim2.new(1,0,1,0); YBtn.BackgroundTransparency=1; YBtn.Text=""
YBtn.MouseButton1Click:Connect(function() CONFIG.Offsets.Y = (CONFIG.Offsets.Y == 12) and -15 or 12; YLbl.Text = "Độ cao: "..CONFIG.Offsets.Y end)

-- DANH SÁCH (Scroll)
local Scroll = Instance.new("ScrollingFrame", Main)
Scroll.Position = UDim2.new(0,0,0,250); Scroll.Size = UDim2.new(1,0,1,-250); Scroll.BackgroundTransparency = 1; Scroll.ScrollBarThickness = 4
local SLayout = Instance.new("UIListLayout", Scroll); SLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center; SLayout.Padding = UDim.new(0,2)
SLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function() Scroll.CanvasSize = UDim2.new(0,0,0,SLayout.AbsoluteContentSize.Y+20) end)

-- --- LOGIC CHÍNH ---

-- Cập nhật danh sách (Quét toàn bộ map + ReplicatedStorage)
local function Refresh()
    local mobs = {}
    -- Quét Workspace
    for _, v in pairs(Workspace:GetDescendants()) do
        if IsAttackable(v) then mobs[v.Name] = (mobs[v.Name] or 0) + 1 end
    end
    -- Quét ReplicatedStorage (Tìm data ẩn)
    for _, v in pairs(ReplicatedStorage:GetDescendants()) do
        if IsAttackable(v) then mobs[v.Name] = (mobs[v.Name] or 0) + 1 end
    end
    
    for _,c in pairs(Scroll:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
    
    for name, count in pairs(mobs) do
        local b = Instance.new("TextButton", Scroll)
        b.Size = UDim2.new(0.95,0,0,30); b.BackgroundColor3 = (CONFIG.SelectedMob == name) and Color3.fromRGB(0,150,255) or Color3.fromRGB(40,40,50)
        b.Text = name .. " [" .. count .. "]"; b.TextColor3 = Color3.new(1,1,1); b.Font = Enum.Font.Gotham; b.TextSize = 12; Instance.new("UICorner", b)
        b.MouseButton1Click:Connect(function() CONFIG.SelectedMob = name; Refresh() end)
    end
end

-- Logic Tấn Công & Gom Quái
task.spawn(function()
    while task.wait() do
        local p = LocalPlayer.Character
        if p and p:FindFirstChild("HumanoidRootPart") then
            
            -- Tìm tất cả quái mục tiêu đang tồn tại trong Workspace (Đã spawn)
            local activeTargets = {}
            for _, v in pairs(Workspace:GetDescendants()) do
                if v.Name == CONFIG.SelectedMob and IsAttackable(v) and v:FindFirstChild("HumanoidRootPart") then
                    table.insert(activeTargets, v)
                end
            end
            
            -- 1. Xử lý GOM QUÁI (Bring)
            if CONFIG.BringEnabled then
                for _, mob in pairs(activeTargets) do
                    local mobRoot = mob:FindFirstChild("HumanoidRootPart")
                    local hum = mob:FindFirstChild("Humanoid")
                    if mobRoot and hum and hum.Health > 0 then
                        -- Cố gắng set CFrame của quái về phía mình (Hoặc ngược lại nếu ko set được quái)
                        -- Cách 1: Teleport quái về mình (Client-sided visual hoặc nếu game lỗi)
                        mobRoot.CFrame = p.HumanoidRootPart.CFrame * CFrame.new(0, 0, -5) -- Gom về trước mặt
                        mobRoot.Velocity = Vector3.new(0,0,0)
                        mobRoot.CanCollide = false
                    end
                end
            end
            
            -- 2. Xử lý TẤN CÔNG (Hit All)
            if CONFIG.AttackEnabled or CONFIG.BringEnabled then
                if RegisterAttack then RegisterAttack:FireServer() end
                
                -- Đánh tất cả quái tìm thấy cùng lúc
                for _, mob in pairs(activeTargets) do
                    local root = mob:FindFirstChild("HumanoidRootPart")
                    if root then
                        if RegisterHit then
                            -- Spam hit vào tất cả
                            RegisterHit:FireServer(root)
                            -- Nếu game check khoảng cách, ta fake khoảng cách bằng cách dịch chuyển nhẹ
                            if CONFIG.BringEnabled then
                                -- Fire thêm lần nữa cho chắc
                                RegisterHit:FireServer(root)
                            end
                        end
                    end
                end
                task.wait(CONFIG.HitDelay) -- Delay cực thấp
            end
        end
    end
end)

-- Logic Teleport (Bay đến quái nếu không muốn Gom)
RunService.Stepped:Connect(function()
    if CONFIG.IsTeleporting and CONFIG.SelectedMob and not CONFIG.BringEnabled then
        local p = LocalPlayer.Character
        local target = nil
        -- Tìm con gần nhất
        local minDist = math.huge
        for _, v in pairs(Workspace:GetDescendants()) do
            if v.Name == CONFIG.SelectedMob and v:FindFirstChild("HumanoidRootPart") and IsAttackable(v) then
                local d = (p.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                if d < minDist then minDist = d; target = v end
            end
        end
        
        if target then
            p.HumanoidRootPart.CFrame = target.HumanoidRootPart.CFrame * CFrame.new(CONFIG.Offsets.X, CONFIG.Offsets.Y, CONFIG.Offsets.Z)
            p.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
        end
    end
end)

-- UI Update loop
task.spawn(function() while task.wait(CONFIG.RefreshRate) do if _G.UltimateHybridUI then Refresh() end end end)

-- Drag UI
local dragging, dragStart, startPos
Title.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = true; dragStart = input.Position; startPos = Main.Position; input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end) end end)
UserInputService.InputChanged:Connect(function(input) if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then local delta = input.Position - dragStart; Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y) end end)
