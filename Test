--[[
    HVK9 ULTIMATE V11 - FIX CRASH & UI
    1. Fix lỗi không hiện bảng (UI).
    2. Tự động nhận diện Executor (Delta, Fluxus, Hydrogen...).
    3. Giữ nguyên Logic Map V10.
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")

local LocalPlayer = Players.LocalPlayer

-- --- CHECK KHỞI TẠO (QUAN TRỌNG) ---
-- Gửi thông báo để biết Script đã bắt đầu chạy
pcall(function()
    StarterGui:SetCore("SendNotification", {
        Title = "HVK9 ULTIMATE V11";
        Text = "Đang khởi động...";
        Duration = 3;
    })
end)

-- --- CẤU HÌNH ---
local CONFIG = {
    AutoFarm = false,
    FastAttack = false,
    SelectedMob = nil,
    TargetPosition = nil,
    WeaponType = "Melee",
    
    FlySpeed = 350,        
    ScanDist = 3000,       
    HoverHeight = 15,      
    IslandWaitY = 50,      
}

-- --- DATA TỌA ĐỘ (GIỮ NGUYÊN TỪ V10) ---
local MOBS_DB = {
    -- SEA 1
    {Name = "Bandit", Level = 5, Pos = Vector3.new(1060, 16, 1550)},
    {Name = "Monkey", Level = 14, Pos = Vector3.new(-1600, 36, 150)},
    {Name = "Gorilla", Level = 20, Pos = Vector3.new(-1240, 6, 480)},
    {Name = "Pirate", Level = 35, Pos = Vector3.new(-1200, 4, 3860)},
    {Name = "Brute", Level = 45, Pos = Vector3.new(-1150, 4, 4000)},
    {Name = "Desert Bandit", Level = 60, Pos = Vector3.new(900, 6, 4390)},
    {Name = "Snow Bandit", Level = 90, Pos = Vector3.new(1350, 87, -1300)},
    {Name = "Sky Bandit", Level = 150, Pos = Vector3.new(-4900, 720, -2600)},
    {Name = "Toga Warrior", Level = 225, Pos = Vector3.new(-1650, 7, -2900)},
    {Name = "Military Soldier", Level = 300, Pos = Vector3.new(-5400, 10, 8500)},
    {Name = "Fishman Warrior", Level = 375, Pos = Vector3.new(61100, 5, 1700)},
    {Name = "Galley Pirate", Level = 625, Pos = Vector3.new(5230, 4, 4000)},

    -- SEA 2
    {Name = "Raider", Level = 700, Pos = Vector3.new(-410, 72, 1780)},
    {Name = "Mercenary", Level = 725, Pos = Vector3.new(-850, 72, 1400)},
    {Name = "Swan Pirate", Level = 775, Pos = Vector3.new(900, 72, 1200)},
    {Name = "Factory Staff", Level = 800, Pos = Vector3.new(280, 72, -180)},
    {Name = "Zombie", Level = 950, Pos = Vector3.new(-5500, 10, -50)},
    {Name = "Snow Trooper", Level = 1000, Pos = Vector3.new(520, 400, -5300)},
    {Name = "Lab Subordinate", Level = 1100, Pos = Vector3.new(-5800, 10, -11000)},
    {Name = "Ship Deckhand", Level = 1250, Pos = Vector3.new(920, 10, -3200)},

    -- SEA 3
    {Name = "Pirate Millionaire", Level = 1500, Pos = Vector3.new(-350, 20, 5500)},
    {Name = "Dragon Crew Warrior", Level = 1575, Pos = Vector3.new(5800, 80, 200)},
    {Name = "Giant Islander", Level = 1650, Pos = Vector3.new(5000, 600, 200)},
    {Name = "Marine Commodore", Level = 1700, Pos = Vector3.new(2450, 80, -7500)},
    {Name = "Fishman Raider", Level = 1775, Pos = Vector3.new(-10700, 30, -8700)},
    {Name = "Reborn Skeleton", Level = 1975, Pos = Vector3.new(-8800, 140, 6000)},
    {Name = "Candy Pirate", Level = 2425, Pos = Vector3.new(-1800, 40, -12500)},
}

-- --- FAST ATTACK ---
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")

task.spawn(function()
    while true do
        task.wait()
        if CONFIG.FastAttack then
            pcall(function()
                local char = LocalPlayer.Character
                if char and char:FindFirstChild("HumanoidRootPart") then
                    local hrp = char.HumanoidRootPart
                    local enemiesToHit = {}
                    local mainTarget = nil
                    
                    local EnemiesFolder = Workspace:FindFirstChild("Enemies")
                    if EnemiesFolder then
                        for _, v in pairs(EnemiesFolder:GetChildren()) do
                            if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v:FindFirstChild("HumanoidRootPart") then
                                local dist = (v.HumanoidRootPart.Position - hrp.Position).Magnitude
                                if dist < 60 then 
                                    table.insert(enemiesToHit, {v, v.HumanoidRootPart})
                                    mainTarget = v.HumanoidRootPart
                                end
                            end
                        end
                    end
                    if mainTarget then
                        RegisterAttack:FireServer(0)
                        RegisterHit:FireServer(mainTarget, enemiesToHit)
                    end
                end
            end)
        end
    end
end)

-- --- HỆ THỐNG BAY ---
local TweenObj = nil
local function FlyTo(targetCF)
    local p = LocalPlayer.Character
    if not p or not p:FindFirstChild("HumanoidRootPart") then return end
    local hrp = p.HumanoidRootPart

    if not hrp:FindFirstChild("HVK_Fly") then
        local bv = Instance.new("BodyVelocity", hrp)
        bv.Name = "HVK_Fly"
        bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
        bv.Velocity = Vector3.new(0,0,0)
    end
    
    for _, part in pairs(p:GetDescendants()) do
        if part:IsA("BasePart") then part.CanCollide = false end
    end

    local dist = (hrp.Position - targetCF.Position).Magnitude
    if dist < 5 then 
        hrp.CFrame = targetCF 
        if TweenObj then TweenObj:Cancel() end
        return 
    end
    
    if TweenObj and TweenObj.PlaybackState == Enum.PlaybackState.Playing and (TweenObj.Instance == hrp) then
        return 
    end

    local speed = CONFIG.FlySpeed
    local info = TweenInfo.new(dist / speed, Enum.EasingStyle.Linear)
    TweenObj = TweenService:Create(hrp, info, {CFrame = targetCF})
    TweenObj:Play()
end

local function StopFly()
    if TweenObj then TweenObj:Cancel() end
    local p = LocalPlayer.Character
    if p and p:FindFirstChild("HumanoidRootPart") and p.HumanoidRootPart:FindFirstChild("HVK_Fly") then
        p.HumanoidRootPart.HVK_Fly:Destroy()
    end
end

-- --- EQUIP TOOL ---
local function EquipWeapon()
    pcall(function()
        local bp = LocalPlayer.Backpack
        local char = LocalPlayer.Character
        if not char then return end
        local toolName = ""
        for _, t in pairs(bp:GetChildren()) do
            if t:IsA("Tool") then
                if CONFIG.WeaponType == "Melee" and t.ToolTip == "Melee" then toolName = t.Name break
                elseif CONFIG.WeaponType == "Sword" and t.ToolTip == "Sword" then toolName = t.Name break
                elseif CONFIG.WeaponType == "Blox Fruit" and t.ToolTip == "Blox Fruit" then toolName = t.Name break end
            end
        end
        if toolName ~= "" and char:FindFirstChild(toolName) == nil then
            char.Humanoid:EquipTool(bp:FindFirstChild(toolName))
        end
    end)
end

-- --- TẠO UI AN TOÀN ---
local function CreateUI()
    if _G.HVK_UI_V11 then _G.HVK_UI_V11:Destroy() end
    
    -- Tìm nơi an toàn để gắn UI
    local parent = game:GetService("CoreGui")
    if not pcall(function() parent = game:GetService("CoreGui") end) then
        parent = LocalPlayer:WaitForChild("PlayerGui")
    end
    
    local Screen = Instance.new("ScreenGui", parent)
    _G.HVK_UI_V11 = Screen
    Screen.Name = "HVK_9"

    local Main = Instance.new("Frame", Screen)
    Main.Size = UDim2.new(0, 300, 0, 400)
    Main.Position = UDim2.new(0.05, 0, 0.25, 0)
    Main.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    Main.BorderSizePixel = 2
    Main.BorderColor3 = Color3.fromRGB(255, 0, 0) -- Viền đỏ để dễ thấy
    Main.Active = true
    Main.Draggable = true -- Cho phép kéo thả bảng

    local Title = Instance.new("TextLabel", Main)
    Title.Size = UDim2.new(1,0,0,40)
    Title.Text = "HVK_9"
    Title.TextColor3 = Color3.fromRGB(255, 255, 0)
    Title.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    Title.Font = Enum.Font.SourceSansBold
    Title.TextSize = 20

    local Status = Instance.new("TextLabel", Main)
    Status.Size = UDim2.new(1,0,0,30)
    Status.Position = UDim2.new(0,0,0,40)
    Status.Text = "Trạng thái: Sẵn sàng"
    Status.TextColor3 = Color3.new(1,1,1)
    Status.BackgroundColor3 = Color3.fromRGB(30, 30, 40)

    local function Btn(txt, y, fn)
        local b = Instance.new("TextButton", Main)
        b.Size = UDim2.new(0.9,0,0,35)
        b.Position = UDim2.new(0.05,0,0,y)
        b.Text = txt
        b.BackgroundColor3 = Color3.fromRGB(60,60,70)
        b.TextColor3 = Color3.new(1,1,1)
        b.Font = Enum.Font.SourceSansBold
        b.TextSize = 16
        b.MouseButton1Click:Connect(function() fn(b) end)
        return b
    end

    Btn("AUTO FARM: OFF", 80, function(b)
        CONFIG.AutoFarm = not CONFIG.AutoFarm
        b.Text = CONFIG.AutoFarm and "AUTO FARM: ON" or "AUTO FARM: OFF"
        b.BackgroundColor3 = CONFIG.AutoFarm and Color3.fromRGB(0, 100, 0) or Color3.fromRGB(60,60,70)
        if not CONFIG.AutoFarm then StopFly() end
    end)

    Btn("FAST ATTACK: OFF", 120, function(b)
        CONFIG.FastAttack = not CONFIG.FastAttack
        b.Text = CONFIG.FastAttack and "FAST ATTACK: ON" or "FAST ATTACK: OFF"
        b.BackgroundColor3 = CONFIG.FastAttack and Color3.fromRGB(200, 0, 0) or Color3.fromRGB(60,60,70)
    end)

    Btn("WEAPON: MELEE", 160, function(b)
        if CONFIG.WeaponType == "Melee" then CONFIG.WeaponType = "Sword"
        elseif CONFIG.WeaponType == "Sword" then CONFIG.WeaponType = "Blox Fruit"
        else CONFIG.WeaponType = "Melee" end
        b.Text = "WEAPON: " .. CONFIG.WeaponType
    end)

    local Scroll = Instance.new("ScrollingFrame", Main)
    Scroll.Size = UDim2.new(0.9,0,0,180)
    Scroll.Position = UDim2.new(0.05,0,0,205)
    Scroll.BackgroundColor3 = Color3.fromRGB(30,30,30)
    local UIList = Instance.new("UIListLayout", Scroll)

    for _, m in pairs(MOBS_DB) do
        local b = Instance.new("TextButton", Scroll)
        b.Size = UDim2.new(1,0,0,30)
        b.Text = m.Name .. " (Lv."..m.Level..")"
        b.BackgroundColor3 = Color3.fromRGB(50,50,55)
        b.TextColor3 = Color3.new(0.9,0.9,0.9)
        b.MouseButton1Click:Connect(function()
            CONFIG.SelectedMob = m.Name
            CONFIG.TargetPosition = m.Pos
            Status.Text = "Target: " .. m.Name
        end)
    end
end

-- Gọi hàm tạo UI
pcall(CreateUI)

-- --- MAIN LOGIC ---
-- Capture Controller an toàn
pcall(function() VirtualUser:CaptureController() end)

task.spawn(function()
    while task.wait(0.2) do
        if CONFIG.AutoFarm and CONFIG.SelectedMob and CONFIG.TargetPosition then
            pcall(function()
                local p = LocalPlayer.Character
                if p and p:FindFirstChild("HumanoidRootPart") and p.Humanoid.Health > 0 then
                    local hrp = p.HumanoidRootPart
                    local distToIsland = (hrp.Position - CONFIG.TargetPosition).Magnitude
                    
                    if distToIsland > CONFIG.ScanDist then
                        -- Bay tới đảo
                        FlyTo(CFrame.new(CONFIG.TargetPosition + Vector3.new(0, 100, 0))) 
                    else
                        -- Tìm quái gần
                        local targetMob = nil
                        local Enemies = Workspace:FindFirstChild("Enemies")
                        if Enemies then
                            for _, v in pairs(Enemies:GetChildren()) do
                                if v.Name == CONFIG.SelectedMob and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                                    if (v.HumanoidRootPart.Position - hrp.Position).Magnitude < CONFIG.ScanDist then
                                        targetMob = v
                                        break
                                    end
                                end
                            end
                        end
                        
                        if targetMob then
                            FlyTo(targetMob.HumanoidRootPart.CFrame * CFrame.new(0, CONFIG.HoverHeight, 0))
                            EquipWeapon()
                            
                            -- Auto Haki an toàn
                            pcall(function()
                                if not p:FindFirstChild("HasBuso") then 
                                    ReplicatedStorage.Remotes.CommF_:InvokeServer("Buso")
                                end
                            end)
                            
                            VirtualUser:Button1Down(Vector2.new(0,0))
                        else
                            FlyTo(CFrame.new(CONFIG.TargetPosition + Vector3.new(0, CONFIG.IslandWaitY, 0)))
                        end
                    end
                end
            end)
        end
    end
end)
