-- HVK9: Phiên bản sửa đầy đủ với Toggle UI, Drag & Drop, Flight tới mục tiêu, Auto-Equip
-- Ghi chú: Cần thay thế GetEnemyFolder/IsAttackable và cách nhận diện vũ khí theo dữ liệu thật của bạn.

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Backpack = LocalPlayer:WaitForChild("Backpack")

-- CONFIG
local CONFIG = {
    FlightEnabled = false,
    SelectedMob = nil,
    FlightSpeed = 60,
    FlightAltitude = 12,
    AutoEquipEnabled = true,
    UI = { Width = 360, Height = 520 },
    NPC_Blacklist = {"Quest", "Shop", "Nurse", "Sailor", "Blacksmith", "Doctor", "Guide"},
    DefaultWeaponName = nil -- tên vũ khí bạn muốn làm mặc định (nếu có)
}

-- 1) UI Setup
if _G.UltimateHybridUI then _G.UltimateHybridUI:Destroy() end
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "UltimateHybridUI"
pcall(function() ScreenGui.Parent = CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end
_G.UltimateHybridUI = ScreenGui

local Main = Instance.new("Frame")
Main.Name = "MainFrame"
Main.Parent = ScreenGui
Main.BackgroundColor3 = Color3.fromRGB(25,25,30)
Main.Position = UDim2.new(0.1, 0, 0.2, 0)
Main.Size = UDim2.new(0, CONFIG.UI.Width, 0, CONFIG.UI.Height)
Main.BorderSizePixel = 0
Instance.new("UICorner", Main)

local TitleBar = Instance.new("Frame", Main)
TitleBar.BackgroundColor3 = Color3.fromRGB(50,55,75)
TitleBar.Size = UDim2.new(1,0,0,40)
Instance.new("UICorner", TitleBar)

local TitleLabel = Instance.new("TextLabel", TitleBar)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Size = UDim2.new(1, -10, 1, 0)
TitleLabel.Position = UDim2.new(0, 5, 0, 0)
TitleLabel.Font = Enum.Font.GothamBlack
TitleLabel.Text = "HVK9"
TitleLabel.TextColor3 = Color3.fromRGB(255,255,255)
TitleLabel.TextSize = 14
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Ô vuông nhỏ để ẩn/hiện UI
local HandleSize = 22
local UIHandle = Instance.new("Frame")
UIHandle.Name = "UIHandle"
UIHandle.Size = UDim2.new(0, HandleSize, 0, HandleSize)
UIHandle.Position = UDim2.new(0, 6, 0, 6)
UIHandle.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
UIHandle.BorderSizePixel = 0
Instance.new("UICorner", UIHandle)
UIHandle.Parent = ScreenGui

local HandleLabel = Instance.new("TextLabel", UIHandle)
HandleLabel.BackgroundTransparency = 1
HandleLabel.Size = UDim2.new(1, 0, 1, 0)
HandleLabel.Text = "≡"
HandleLabel.TextColor3 = Color3.fromRGB(255,255,255)
HandleLabel.TextScaled = true
HandleLabel.Font = Enum.Font.GothamBold

local uiVisible = true
UIHandle.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        uiVisible = not uiVisible
        Main.Visible = uiVisible
        -- Tuy nhiên, đừng destroy UI. Giữ làm trạng thái để có thể mở lại nhanh chóng.
    end
end)

-- Drag & Drop cho Main Frame (draggable)
local dragging = false
local dragStart = Vector2.new()
local startPos = Main.Position

local function clampToScreen(pos)
    local screenSize = ScreenGui.AbsoluteSize
    local maxX = math.max(0, screenSize.X - Main.Size.X.Offset)
    local maxY = math.max(0, screenSize.Y - Main.Size.Y.Offset)
    local newX = math.clamp(pos.X.Offset, 0, maxX)
    local newY = math.clamp(pos.Y.Offset, 0, maxY)
    return UDim2.new(pos.X.Scale, newX, pos.Y.Scale, newY)
end

TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = Main.Position

        local moveConn
        moveConn = UserInputService.InputChanged:Connect(function(change)
            if not dragging then return end
            if change.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = Vector2.new(change.Position.X - dragStart.X, change.Position.Y - dragStart.Y)
                local newPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
                                       startPos.Y.Scale, startPos.Y.Offset + delta.Y)
                Main.Position = clampToScreen(newPos)
            end
        end)

        local upConn
        upConn = UserInputService.InputEnded:Connect(function(endInput)
            if endInput.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
                if moveConn then moveConn:Disconnect() end
                if upConn then upConn:Disconnect() end
            end
        end)
    end
end)

-- 3) Danh sách quái và cập nhật
local ListLabel = Instance.new("TextLabel", Main)
ListLabel.Text = "DANH SÁCH QUÁI (Click để chọn):"
ListLabel.Font = Enum.Font.GothamBold
ListLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
ListLabel.TextSize = 11
ListLabel.Size = UDim2.new(1, 0, 0, 20)
ListLabel.Position = UDim2.new(0, 0, 0, 250)
ListLabel.BackgroundTransparency = 1

local ScrollList = Instance.new("ScrollingFrame")
ScrollList.Parent = Main
ScrollList.BackgroundTransparency = 1
ScrollList.Position = UDim2.new(0, 0, 0, 270)
ScrollList.Size = UDim2.new(1, 0, 1, -270)
ScrollList.CanvasSize = UDim2.new(0, 0, 0, 0)
ScrollList.ScrollBarThickness = 6

local ListLayout = Instance.new("UIListLayout", ScrollList)
ListLayout.Padding = UDim.new(0, 6)
ListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
ListLayout.SortOrder = Enum.SortOrder.LayoutOrder

ListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ScrollList.CanvasSize = UDim2.new(0, 0, 0, ListLayout.AbsoluteContentSize.Y + 10)
end)

local mobsCache = {} -- { mobName = count }

local function IsAttackable(v)
    if not v:IsA("Model") then return false end
    if v == LocalPlayer.Character then return false end
    if Players:GetPlayerFromCharacter(v) then return false end
    local hum = v:FindFirstChildOfClass("Humanoid")
    local root = v:FindFirstChild("HumanoidRootPart")
    if hum and root and hum.Health > 0 then
        local nameLower = v.Name:lower()
        for _, b in pairs(CONFIG.NPC_Blacklist) do
            if string.find(nameLower, b:lower()) then return false end
        end
        return true
    end
    return false
end

local function GetEnemyFolder()
    local candidates = {"Enemies", "Mobs", "Monsters", "NPCs", "Live"}
    for _, name in ipairs(candidates) do
        local f = Workspace:FindFirstChild(name)
        if f then return f end
    end
    return Workspace
end

local function RefreshMobList()
    mobsCache = {}
    local folder = GetEnemyFolder()
    for _, obj in pairs(folder:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("HumanoidRootPart") then
            if IsAttackable(obj) then
                local nm = obj.Name
                mobsCache[nm] = (mobsCache[nm] or 0) + 1
            end
        end
    end

    -- Xóa nút cũ
    for _, c in pairs(ScrollList:GetChildren()) do
        if c:IsA("TextButton") then c:Destroy() end
    end

    -- Tạo nút mới
    for name, count in pairs(mobsCache) do
        local btn = Instance.new("TextButton")
        btn.Parent = ScrollList
        btn.Size = UDim2.new(0.9, 0, 0, 30)
        btn.BackgroundColor3 = (CONFIG.SelectedMob == name) and Color3.fromRGB(0, 120, 215) or Color3.fromRGB(40, 40, 50)
        btn.Text = "  " .. name .. " [" .. count .. "]"
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.TextXAlignment = Enum.TextXAlignment.Left
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 12
        Instance.new("UICorner", btn)

        btn.MouseButton1Click:Connect(function()
            CONFIG.SelectedMob = name
            RefreshMobList() -- cập nhật highlight
        end)
    end
end

RefreshMobList()

-- 4) Flight (bay tới mục tiêu)
local flightConnection
local function GetTargetRootPart()
    if not CONFIG.SelectedMob then return nil end
    local folder = GetEnemyFolder()
    for _, m in pairs(folder:GetDescendants()) do
        if m:IsA("Model") and m.Name == CONFIG.SelectedMob and m:FindFirstChild("HumanoidRootPart") then
            return m.HumanoidRootPart
        end
    end
    return nil
end

local function StartFlightToTarget(targetHRP)
    if not targetHRP then return end
    local hrp = targetHRP
    local playerHRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not playerHRP then return end

    if flightConnection then flightConnection:Disconnect() end
    flightConnection = RunService.RenderStepped:Connect(function(dt)
        if not CONFIG.FlightEnabled then return end
        local dest = Vector3.new(hrp.Position.X, hrp.Position.Y + CONFIG.FlightAltitude, hrp.Position.Z)
        local cur = playerHRP.Position
        local dir = dest - cur
        local dist = dir.Magnitude
        if dist < 2 then
            return
        end
        local step = math.min(CONFIG.FlightSpeed * dt, dist)
        local move = dir.Unit * step
        playerHRP.CFrame = CFrame.new(cur + move)
        LocalPlayer.Character:SetPrimaryPartCFrame(CFrame.new(playerHRP.Position, dest))
    end)
end

local function StopFlight()
    if flightConnection then flightConnection:Disconnect() flightConnection = nil end
end

spawn(function()
    while true do
        local targetHRP = GetTargetRootPart()
        if CONFIG.FlightEnabled and targetHRP then
            StartFlightToTarget(targetHRP)
        else
            StopFlight()
        end
        wait(0.2)
    end
end)

-- 5) Auto Equip
local function DetermineWeaponCategory(tool)
    if not tool then return nil end
    local name = tool.Name:lower()
    if string.find(name, "sword") or string.find(name, "blade") then
        return "Sword"
    elseif string.find(name, "gun") or string.find(name, "rifle") or string.find(name, "pistol") then
        return "Gun"
    elseif string.find(name, "knife") or string.find(name, "dagger") then
        return "Melee"
    elseif string.find(name, "wheel") or string.find(name, "quake") or string.find(name, "stun") then
        return "Wheel"
    end
    return nil
end

local lastEquipState = false
local function AutoEquip()
    -- Chỉ chạy khi bật AutoEquip
    if not CONFIG.AutoEquipEnabled then return end

    -- Nếu có một vũ khí được chọn làm mặc định, ưu tiên nó
    if CONFIG.DefaultWeaponName then
        local t = Backpack:FindFirstChild(CONFIG.DefaultWeaponName)
        if t and t:IsA("Tool") and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid:EquipTool(t)
            lastEquipState = true
            return
        end
    end

    local preferred = { "Sword", "Gun", "Melee", "Wheel" }
    local items = {}
    for _, tool in pairs(Backpack:GetChildren()) do
        if tool:IsA("Tool") then
            local cat = DetermineWeaponCategory(tool)
            table.insert(items, {Tool = tool, Cat = cat})
        end
    end

    for _, cat in ipairs(preferred) do
        for _, entry in ipairs(items) do
            if entry.Cat == cat then
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                    LocalPlayer.Character.Humanoid:EquipTool(entry.Tool)
                    lastEquipState = true
                    return
                end
            end
        end
    end

    if #items > 0 and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid:EquipTool(items[1].Tool)
        lastEquipState = true
    else
        lastEquipState = false
    end
end

-- Trigger AutoEquip on Mob select or on a timer with throttling
local autoEquipCooldown = 0
spawn(function()
    while true do
        if CONFIG.AutoEquipEnabled then
            local now = tick()
            if now - autoEquipCooldown > 2 then
                AutoEquip()
                autoEquipCooldown = now
            end
        end
        RunService.RenderStepped:Wait()
    end
end)

-- 6) Giữ danh sách Mob liên tục (optional)
spawn(function()
    while true do
        RefreshMobList()
        wait(5)
    end
end)

-- 7) Highlight UI khi chọn
spawn(function()
    while true do
        for _, btn in pairs(ScrollList:GetChildren()) do
            if btn:IsA("TextButton") then
                local nm = btn.Text:match("^  (.-) %[")
                if nm and nm == CONFIG.SelectedMob then
                    btn.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
                else
                    btn.BackgroundColor3 = Color3.fromRGB(40,40,50)
                end
            end
        end
        wait(0.5)
    end
end)

-- END
