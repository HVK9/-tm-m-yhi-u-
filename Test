--[[
    ULTIMATE HYBRID V14: FIX BLANK UI & SMART WEAPON
    - Fix: Sửa lỗi UI bị trắng trơn (do lỗi clip descendants).
    - New: Chế độ thu nhỏ thành icon hình vuông.
    - New: Tự động chọn vũ khí theo loại (Cận chiến, Kiếm, Súng, Trái ác quỷ) bằng cách đọc dữ liệu game.
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local Net = ReplicatedStorage:WaitForChild("Modules", 10) and ReplicatedStorage.Modules:WaitForChild("Net", 10) 
if not Net then warn("Lưu ý: Game này có thể không dùng Net Module, script sẽ chạy chế độ click thường.") end 

local RegisterAttack = Net and Net:FindFirstChild("RE/RegisterAttack")
local RegisterHit = Net and Net:FindFirstChild("RE/RegisterHit")

-- --- CẤU HÌNH ---
local CONFIG = {
    IsTeleporting = false,
    SelectedMob = nil,
    Offsets = {X = 0, Y = 12, Z = 0},
    RefreshRate = 1.5,
    AttackEnabled = false,
    MaxTargets = 5,
    AttackRange = 120,
    HitDelay = 0.05,
    NPC_Blacklist = {"Quest", "Shop", "Nurse", "Sailor", "Blacksmith", "Doctor", "Guide"},
    -- Cấu hình vũ khí
    AutoEquip = false,
    WeaponType = "Melee" -- Các loại: Melee, Sword, Gun, Blox Fruit
}

if _G.UltimateHybridUI then _G.UltimateHybridUI:Destroy() end

-- --- HÀM HỖ TRỢ ---
local function IsAttackable(v)
    if not v:IsA("Model") then return false end
    if v == LocalPlayer.Character then return false end
    if Players:GetPlayerFromCharacter(v) then return false end
    
    local hum = v:FindFirstChildOfClass("Humanoid")
    local root = v:FindFirstChild("HumanoidRootPart")
    
    if hum and root and hum.Health > 0 then
        local nameLower = v.Name:lower()
        for _, bName in pairs(CONFIG.NPC_Blacklist) do
            if string.find(nameLower, bName:lower()) then return false end
        end
        return true
    end
    return false
end

local function GetEnemyFolder()
    local targets = {"Enemies", "Mobs", "Monsters", "NPCs", "Live"}
    for _, name in pairs(targets) do
        local f = Workspace:FindFirstChild(name)
        if f then return f end
    end
    return Workspace 
end

-- --- GIAO DIỆN UI (ĐƯỢC LÀM LẠI) ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "UltimateHybridUI"
pcall(function() ScreenGui.Parent = CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer.PlayerGui end
_G.UltimateHybridUI = ScreenGui

-- Frame Chính
local Main = Instance.new("Frame")
Main.Parent = ScreenGui
Main.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
Main.Position = UDim2.new(0.1, 0, 0.2, 0)
Main.Size = UDim2.new(0, 300, 0, 450)
Main.BorderSizePixel = 0
Main.ClipsDescendants = true -- Để hiệu ứng thu nhỏ mượt hơn
local MainCorner = Instance.new("UICorner", Main)
MainCorner.CornerRadius = UDim.new(0, 8)

-- Thanh Tiêu Đề (Title Bar)
local TitleBar = Instance.new("Frame")
TitleBar.Parent = Main
TitleBar.BackgroundColor3 = Color3.fromRGB(50, 55, 75)
TitleBar.Size = UDim2.new(1, 0, 0, 40)
local TitleCorner = Instance.new("UICorner", TitleBar)
TitleCorner.CornerRadius = UDim.new(0, 8)

-- Che phần dưới của TitleBar để nối liền với Main
local TitleFiller = Instance.new("Frame", TitleBar)
TitleFiller.BorderSizePixel = 0
TitleFiller.BackgroundColor3 = TitleBar.BackgroundColor3
TitleFiller.Size = UDim2.new(1, 0, 0, 10)
TitleFiller.Position = UDim2.new(0, 0, 1, -10)

local TitleText = Instance.new("TextLabel")
TitleText.Parent = TitleBar
TitleText.BackgroundTransparency = 1
TitleText.Size = UDim2.new(0, 200, 1, 0)
TitleText.Position = UDim2.new(0, 10, 0, 0)
TitleText.Font = Enum.Font.GothamBlack
TitleText.Text = "HVK9 HYBRID"
TitleText.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleText.TextSize = 14
TitleText.TextXAlignment = Enum.TextXAlignment.Left

-- NÚT THU NHỎ (MINIMIZE BUTTON)
local MinimizeBtn = Instance.new("TextButton")
MinimizeBtn.Parent = ScreenGui -- Đặt hẳn ra ngoài Main để dễ xử lý khi Main thu nhỏ
MinimizeBtn.Name = "MinimizeButton"
MinimizeBtn.Size = UDim2.new(0, 40, 0, 40)
MinimizeBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
MinimizeBtn.Text = "_"
MinimizeBtn.Font = Enum.Font.GothamBold
MinimizeBtn.TextColor3 = Color3.WHITE
MinimizeBtn.TextSize = 20
Instance.new("UICorner", MinimizeBtn, UDim.new(0, 8))
MinimizeBtn.Visible = false -- Ẩn mặc định, chỉ hiện khi cần hoặc dùng logic khác

-- Logic Thu Nhỏ đặc biệt (Biến Main thành hình vuông nhỏ)
local ToggleSizeBtn = Instance.new("TextButton")
ToggleSizeBtn.Parent = TitleBar
ToggleSizeBtn.Size = UDim2.new(0, 30, 0, 30)
ToggleSizeBtn.Position = UDim2.new(1, -35, 0, 5)
ToggleSizeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
ToggleSizeBtn.Text = "-"
ToggleSizeBtn.TextColor3 = Color3.WHITE
ToggleSizeBtn.Font = Enum.Font.GothamBold
ToggleSizeBtn.TextSize = 18
Instance.new("UICorner", ToggleSizeBtn, UDim.new(0, 6))

local ContentContainer = Instance.new("Frame")
ContentContainer.Parent = Main
ContentContainer.BackgroundTransparency = 1
ContentContainer.Position = UDim2.new(0, 0, 0, 45)
ContentContainer.Size = UDim2.new(1, 0, 1, -45)

local isMinimized = false
local oldSize = Main.Size
local oldPos = Main.Position

ToggleSizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    if isMinimized then
        -- Lưu vị trí cũ
        oldPos = Main.Position
        
        -- Ẩn nội dung
        ContentContainer.Visible = false
        TitleText.Visible = false
        
        -- Thu nhỏ thành hình vuông
        Main:TweenSize(UDim2.new(0, 50, 0, 50), "Out", "Quad", 0.3, true)
        
        ToggleSizeBtn.Text = "+"
        ToggleSizeBtn.BackgroundColor3 = Color3.fromRGB(40, 150, 80)
        -- Chỉnh nút toggle ra giữa hình vuông
        ToggleSizeBtn.Size = UDim2.new(1, 0, 1, 0)
        ToggleSizeBtn.Position = UDim2.new(0, 0, 0, 0)
        TitleBar.BackgroundTransparency = 1 -- Ẩn thanh tiêu đề đi cho đẹp
        TitleFiller.Visible = false
        Main.BackgroundColor3 = Color3.fromRGB(50, 55, 75) -- Màu của icon khi thu nhỏ
    else
        -- Mở rộng ra
        Main:TweenSize(UDim2.new(0, 300, 0, 450), "Out", "Quad", 0.3, true)
        
        task.wait(0.2)
        ContentContainer.Visible = true
        TitleText.Visible = true
        TitleBar.BackgroundTransparency = 0
        TitleFiller.Visible = true
        Main.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
        
        ToggleSizeBtn.Text = "-"
        ToggleSizeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        ToggleSizeBtn.Size = UDim2.new(0, 30, 0, 30)
        ToggleSizeBtn.Position = UDim2.new(1, -35, 0, 5)
    end
end)

-- --- KHU VỰC CHỨC NĂNG (BÊN TRONG CONTENT CONTAINER) ---
local ControlLayout = Instance.new("UIListLayout", ContentContainer)
ControlLayout.Padding = UDim.new(0, 10)
ControlLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
ControlLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- Hàm tạo nút nhanh
local function CreateButton(text, color, callback)
    local btn = Instance.new("TextButton")
    btn.Parent = ContentContainer
    btn.Size = UDim2.new(0.9, 0, 0, 40)
    btn.BackgroundColor3 = color
    btn.Font = Enum.Font.GothamBold
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 13
    Instance.new("UICorner", btn)
    btn.MouseButton1Click:Connect(function() callback(btn) end)
    return btn
end

-- 1. Nút Auto Attack
CreateButton("AUTO ATTACK: OFF", Color3.fromRGB(60, 60, 70), function(btn)
    CONFIG.AttackEnabled = not CONFIG.AttackEnabled
    btn.Text = CONFIG.AttackEnabled and "AUTO ATTACK: ON" or "AUTO ATTACK: OFF"
    btn.BackgroundColor3 = CONFIG.AttackEnabled and Color3.fromRGB(200, 50, 50) or Color3.fromRGB(60, 60, 70)
end)

-- 2. Nút Chọn Loại Vũ Khí (MỚI - SMART WEAPON)
local WeaponFrame = Instance.new("Frame")
WeaponFrame.Parent = ContentContainer
WeaponFrame.Size = UDim2.new(0.9, 0, 0, 45)
WeaponFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
Instance.new("UICorner", WeaponFrame)

local WeaponLabel = Instance.new("TextLabel")
WeaponLabel.Parent = WeaponFrame
WeaponLabel.Size = UDim2.new(1, 0, 0.4, 0)
WeaponLabel.BackgroundTransparency = 1
WeaponLabel.Text = "  CHỌN LOẠI VŨ KHÍ (AUTO):"
WeaponLabel.Font = Enum.Font.GothamBold
WeaponLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
WeaponLabel.TextSize = 10
WeaponLabel.TextXAlignment = Enum.TextXAlignment.Left

local WeaponTypeBtn = Instance.new("TextButton")
WeaponTypeBtn.Parent = WeaponFrame
WeaponTypeBtn.Size = UDim2.new(0.45, 0, 0.5, 0)
WeaponTypeBtn.Position = UDim2.new(0.02, 0, 0.45, 0)
WeaponTypeBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
WeaponTypeBtn.Text = "LOẠI: CẬN CHIẾN"
WeaponTypeBtn.TextColor3 = Color3.WHITE
WeaponTypeBtn.Font = Enum.Font.GothamBold
WeaponTypeBtn.TextSize = 11
Instance.new("UICorner", WeaponTypeBtn)

local WeaponToggleBtn = Instance.new("TextButton")
WeaponToggleBtn.Parent = WeaponFrame
WeaponToggleBtn.Size = UDim2.new(0.45, 0, 0.5, 0)
WeaponToggleBtn.Position = UDim2.new(0.53, 0, 0.45, 0)
WeaponToggleBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
WeaponToggleBtn.Text = "EQUIP: OFF"
WeaponToggleBtn.TextColor3 = Color3.WHITE
WeaponToggleBtn.Font = Enum.Font.GothamBold
WeaponToggleBtn.TextSize = 11
Instance.new("UICorner", WeaponToggleBtn)

-- Logic đổi loại vũ khí
local wTypes = {"Melee", "Sword", "Gun", "Blox Fruit"}
local wNamesVN = {Melee="CẬN CHIẾN", Sword="KIẾM", Gun="SÚNG", ["Blox Fruit"]="TRÁI ÁC QUỶ"}
local currentWIndex = 1

WeaponTypeBtn.MouseButton1Click:Connect(function()
    currentWIndex = currentWIndex + 1
    if currentWIndex > #wTypes then currentWIndex = 1 end
    CONFIG.WeaponType = wTypes[currentWIndex]
    WeaponTypeBtn.Text = "LOẠI: " .. wNamesVN[CONFIG.WeaponType]
end)

WeaponToggleBtn.MouseButton1Click:Connect(function()
    CONFIG.AutoEquip = not CONFIG.AutoEquip
    WeaponToggleBtn.Text = CONFIG.AutoEquip and "EQUIP: ON" or "EQUIP: OFF"
    WeaponToggleBtn.BackgroundColor3 = CONFIG.AutoEquip and Color3.fromRGB(200, 50, 50) or Color3.fromRGB(60, 60, 70)
end)

-- 3. Nút Teleport
CreateButton("TELEPORT MOB: OFF", Color3.fromRGB(40, 150, 80), function(btn)
    if not CONFIG.SelectedMob then 
        btn.Text = "⚠️ CHƯA CHỌN QUÁI!" 
        task.wait(1) 
        btn.Text = "TELEPORT MOB: OFF" 
        return 
    end
    CONFIG.IsTeleporting = not CONFIG.IsTeleporting
    btn.Text = CONFIG.IsTeleporting and "STOP TELEPORT" or "TELEPORT MOB: OFF"
    btn.BackgroundColor3 = CONFIG.IsTeleporting and Color3.fromRGB(200, 50, 50) or Color3.fromRGB(40, 150, 80)
end)

-- 4. Thanh chỉnh độ cao (Slider)
local YFrame = Instance.new("Frame")
YFrame.Parent = ContentContainer
YFrame.Size = UDim2.new(0.9, 0, 0, 40)
YFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
Instance.new("UICorner", YFrame)

local YLabel = Instance.new("TextLabel")
YLabel.Parent = YFrame
YLabel.BackgroundTransparency = 1
YLabel.Size = UDim2.new(1, 0, 0, 20)
YLabel.Font = Enum.Font.GothamBold
YLabel.Text = "Độ cao bay: " .. CONFIG.Offsets.Y
YLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
YLabel.TextSize = 12

local YBar = Instance.new("Frame")
YBar.Parent = YFrame
YBar.Size = UDim2.new(0.8, 0, 0, 4)
YBar.Position = UDim2.new(0.1, 0, 0.7, 0)
YBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
local YFill = Instance.new("Frame", YBar)
YFill.Size = UDim2.new(0.6, 0, 1, 0)
YFill.BackgroundColor3 = Color3.fromRGB(0, 200, 255)
YFill.BorderSizePixel = 0

local YTrigger = Instance.new("TextButton", YFrame)
YTrigger.BackgroundTransparency = 1
YTrigger.Size = UDim2.new(1,0,1,0)
YTrigger.Text = ""
YTrigger.MouseButton1Down:Connect(function()
    local function UpdateSlider()
        local rX = math.clamp((UserInputService:GetMouseLocation().X - YBar.AbsolutePosition.X) / YBar.AbsoluteSize.X, 0, 1)
        YFill.Size = UDim2.new(rX, 0, 1, 0)
        CONFIG.Offsets.Y = math.floor(-20 + (50 * rX))
        YLabel.Text = "Độ cao bay: " .. CONFIG.Offsets.Y
    end
    UpdateSlider()
    local move = UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then UpdateSlider() end
    end)
    local release
    release = UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
             move:Disconnect(); release:Disconnect()
        end
    end)
end)

-- 5. Danh sách quái (Phần còn lại)
local ListLabel = Instance.new("TextLabel")
ListLabel.Parent = ContentContainer
ListLabel.Text = "  DANH SÁCH QUÁI (Click để chọn):"
ListLabel.Font = Enum.Font.GothamBold
ListLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
ListLabel.TextSize = 11
ListLabel.Size = UDim2.new(1, 0, 0, 20)
ListLabel.TextXAlignment = Enum.TextXAlignment.Left
ListLabel.BackgroundTransparency = 1

local ScrollList = Instance.new("ScrollingFrame")
ScrollList.Parent = ContentContainer
ScrollList.BackgroundTransparency = 1
ScrollList.Size = UDim2.new(0.95, 0, 1, -260) -- Tính toán lại size cho vừa
ScrollList.CanvasSize = UDim2.new(0, 0, 0, 0)
ScrollList.ScrollBarThickness = 4
ScrollList.BorderSizePixel = 0

local ListLayout = Instance.new("UIListLayout", ScrollList)
ListLayout.Padding = UDim.new(0, 4)
ListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
ListLayout.SortOrder = Enum.SortOrder.LayoutOrder

ListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ScrollList.CanvasSize = UDim2.new(0, 0, 0, ListLayout.AbsoluteContentSize.Y + 10)
end)

-- --- LOGIC HỆ THỐNG ---

-- Logic Auto Equip Smart (Dựa trên ToolTip)
task.spawn(function()
    while task.wait(0.5) do
        if CONFIG.AutoEquip then
            local p = LocalPlayer.Character
            local backpack = LocalPlayer.Backpack
            if p and backpack then
                local currentTool = p:FindFirstChildOfClass("Tool")
                local targetType = CONFIG.WeaponType -- "Melee", "Sword", "Gun", "Blox Fruit"
                
                -- Check xem đang cầm đúng loại chưa
                local isEquippedCorrectly = false
                if currentTool then
                    -- Kiểm tra ToolTip của vũ khí đang cầm
                    if string.find(currentTool.ToolTip, targetType) or (targetType == "Melee" and currentTool.ToolTip == "") then
                        isEquippedCorrectly = true
                    end
                end
                
                if not isEquippedCorrectly then
                    -- Tìm trong Balo
                    for _, tool in pairs(backpack:GetChildren()) do
                        if tool:IsA("Tool") then
                            -- Logic nhận diện vũ khí Blox Fruits
                            local tt = tool.ToolTip
                            if string.find(tt, targetType) then
                                p.Humanoid:EquipTool(tool)
                                break
                            elseif targetType == "Melee" and (tt == "" or tt == "Fighting Style") then
                                -- Thường Melee không có Tooltip hoặc là Fighting Style
                                p.Humanoid:EquipTool(tool)
                                break
                            end
                        end
                    end
                end
            end
        end
    end
end)

-- Logic Refresh Quái
local function RefreshMobList()
    local mobs = {}
    local scanFolder = GetEnemyFolder()
    
    for _, v in pairs(scanFolder:GetDescendants()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
             if IsAttackable(v) then
                mobs[v.Name] = (mobs[v.Name] or 0) + 1
            end
        end
    end
    
    for _, c in pairs(ScrollList:GetChildren()) do
        if c:IsA("TextButton") then c:Destroy() end
    end
    
    for name, count in pairs(mobs) do
        local btn = Instance.new("TextButton")
        btn.Parent = ScrollList
        btn.Size = UDim2.new(0.95, 0, 0, 25)
        btn.BackgroundColor3 = (CONFIG.SelectedMob == name) and Color3.fromRGB(0, 120, 215) or Color3.fromRGB(40, 40, 50)
        btn.Text = "  " .. name .. " [" .. count .. "]"
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.TextXAlignment = Enum.TextXAlignment.Left
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 11
        Instance.new("UICorner", btn, UDim.new(0, 4))
        
        btn.MouseButton1Click:Connect(function()
            CONFIG.SelectedMob = name
            RefreshMobList()
        end)
    end
end

-- Logic Attack
task.spawn(function()
    while task.wait() do
        if CONFIG.AttackEnabled and RegisterAttack and RegisterHit then
            local p = LocalPlayer.Character
            if p and p:FindFirstChild("HumanoidRootPart") then
                local targets = {}
                for _, v in pairs(Workspace:GetChildren()) do
                    if v:IsA("Model") and v ~= p and IsAttackable(v) then
                         if (v.HumanoidRootPart.Position - p.HumanoidRootPart.Position).Magnitude <= CONFIG.AttackRange then
                              table.insert(targets, v.HumanoidRootPart)
                         end
                    end
                    local enemiesFolder = Workspace:FindFirstChild("Enemies")
                    if enemiesFolder then
                        for _, e in pairs(enemiesFolder:GetChildren()) do
                             if e:IsA("Model") and IsAttackable(e) and (e.HumanoidRootPart.Position - p.HumanoidRootPart.Position).Magnitude <= CONFIG.AttackRange then
                                  table.insert(targets, e.HumanoidRootPart)
                             end
                        end
                    end
                 end
                
                if #targets > 0 then
                    RegisterAttack:FireServer()
                    for i=1, math.min(#targets, CONFIG.MaxTargets) do
                         RegisterHit:FireServer(targets[i])
                        task.wait(CONFIG.HitDelay)
                    end
                end
            end
        end
     end
end)

-- Logic Teleport
RunService.Stepped:Connect(function()
    if CONFIG.IsTeleporting and CONFIG.SelectedMob then
        local p = LocalPlayer.Character
        if p and p:FindFirstChild("HumanoidRootPart") then
            local target = nil
            local minDist = math.huge
            local scanFolder = GetEnemyFolder()
            
             for _, v in pairs(scanFolder:GetDescendants()) do
                if v.Name == CONFIG.SelectedMob and IsAttackable(v) then
                    local dist = (p.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                    if dist < minDist then
                        minDist = dist
                        target = v
                    end
                end
            end
            
             if target then
                p.HumanoidRootPart.CFrame = target.HumanoidRootPart.CFrame * CFrame.new(CONFIG.Offsets.X, CONFIG.Offsets.Y, CONFIG.Offsets.Z)
                p.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
            end
        end
    end
end)

task.spawn(function()
    while task.wait(CONFIG.RefreshRate) do
        if _G.UltimateHybridUI and _G.UltimateHybridUI.Parent then
            RefreshMobList()
        else
             break
        end
    end
end)

-- Kéo thả UI (Hỗ trợ cả khi thu nhỏ)
local dragging, dragStart, startPos
TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = Main.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
