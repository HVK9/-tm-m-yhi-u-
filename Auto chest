--[[ 
    AUTO CHEST SEA 1 - V4 (CONTROL VERSION)
    - UI Trong su·ªët, b·∫•m v√†o ch·ªØ ƒë·ªÉ B·∫≠t/T·∫Øt.
    - M√†u ch·ªØ thay ƒë·ªïi theo tr·∫°ng th√°i (ƒê·ªè/Xanh).
    - T·ªëi ∆∞u h√≥a c·ª±c nh·∫π (Lite Logic).
]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer

-- // C·∫§U H√åNH //
local Config = {
    Speed = 350,             -- T·ªëc ƒë·ªô bay
    MinDistance = 8,         -- Kho·∫£ng c√°ch nh·∫∑t
    IslandRadius = 3500,     -- B√°n k√≠nh ƒë·∫£o
    WaitTime = 0.1           -- Th·ªùi gian ngh·ªâ
}

-- Bi·∫øn tr·∫°ng th√°i to√†n c·ª•c
_G.AutoChestEnabled = false -- M·∫∑c ƒë·ªãnh l√† T·∫ÆT
local BlacklistedChests = {} -- R∆∞∆°ng ƒë√£ ƒÉn
local ChestCache = {}        -- Danh s√°ch r∆∞∆°ng t·∫°m th·ªùi
local currentTween = nil     -- L∆∞u tween hi·ªán t·∫°i ƒë·ªÉ h·ªßy khi t·∫Øt

local Islands = {
    {Name = "Starter Island",   Pos = Vector3.new(1000, 100, 1000)},
    {Name = "Jungle (Khi)",     Pos = Vector3.new(-1600, 50, 300)},
    {Name = "Pirate Village",   Pos = Vector3.new(-1200, 50, 3900)},
    {Name = "Desert (Sa Mac)",  Pos = Vector3.new(1000, 50, 4100)},
    {Name = "Snow (Tuyet)",     Pos = Vector3.new(1200, 50, -1400)},
    {Name = "Marine Fortress",  Pos = Vector3.new(-5000, 50, 500)},
    {Name = "Skypiea (Troi)",   Pos = Vector3.new(-4900, 600, -2000)},
    {Name = "Prison (Tu)",      Pos = Vector3.new(5000, 50, 500)},
    {Name = "Colosseum",        Pos = Vector3.new(-1600, 50, -2900)},
    {Name = "Magma",            Pos = Vector3.new(-5400, 50, 8600)},
    {Name = "Fountain City",    Pos = Vector3.new(5300, 50, 4100)},
}

local currentIslandIndex = 1
local isTraveling = true 

-- // T·∫†O UI (BUTTON TRONG SU·ªêT) //
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoChestControl"
-- ∆Øu ti√™n ƒë∆∞a v√†o CoreGui ƒë·ªÉ an to√†n, n·∫øu kh√¥ng th√¨ PlayerGui
pcall(function() ScreenGui.Parent = CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Name = "StatusBtn"
ToggleBtn.Size = UDim2.new(0, 400, 0, 40) -- K√≠ch th∆∞·ªõc v√πng b·∫•m
ToggleBtn.Position = UDim2.new(0.5, -200, 0, 10) -- Ch√≠nh gi·ªØa tr√™n c√πng
ToggleBtn.BackgroundTransparency = 1 -- [QUAN TR·ªåNG] Trong su·ªët ho√†n to√†n
ToggleBtn.Text = "üî¥ AUTO CHEST: OFF (Click to Start)"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 50, 50) -- M√†u ƒê·ªé (M·∫∑c ƒë·ªãnh t·∫Øt)
ToggleBtn.Font = Enum.Font.Code
ToggleBtn.TextSize = 18
ToggleBtn.TextStrokeTransparency = 0.5 -- Vi·ªÅn ch·ªØ nh·∫π ƒë·ªÉ d·ªÖ nh√¨n
ToggleBtn.Parent = ScreenGui

-- // H√ÄM D·ª™NG HO·∫†T ƒê·ªòNG (CLEANUP) //
local function StopScript()
    if currentTween then currentTween:Cancel() end
    
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        local bv = char.HumanoidRootPart:FindFirstChild("BodyVelocity")
        if bv then bv:Destroy() end -- X√≥a l·ª±c bay ƒë·ªÉ nh√¢n v·∫≠t r∆°i xu·ªëng
    end
end

-- // X·ª¨ L√ù N√öT B·∫§M //
ToggleBtn.MouseButton1Click:Connect(function()
    _G.AutoChestEnabled = not _G.AutoChestEnabled
    
    if _G.AutoChestEnabled then
        -- KHI B·∫¨T
        ToggleBtn.Text = "üü¢ AUTO CHEST: RUNNING..."
        ToggleBtn.TextColor3 = Color3.fromRGB(50, 255, 50) -- M√†u XANH
    else
        -- KHI T·∫ÆT
        ToggleBtn.Text = "üî¥ AUTO CHEST: PAUSED"
        ToggleBtn.TextColor3 = Color3.fromRGB(255, 50, 50) -- M√†u ƒê·ªé
        StopScript()
    end
end)

-- // NOCLIP (Ch·ªâ ch·∫°y khi ƒëang B·∫≠t) //
RunService.Stepped:Connect(function()
    if _G.AutoChestEnabled and LocalPlayer.Character then
        for _, v in pairs(LocalPlayer.Character:GetChildren()) do
            if v:IsA("BasePart") and v.CanCollide then
                v.CanCollide = false
            end
        end
    end
end)

-- // H√ÄM BAY //
local function TweenTo(targetPos)
    if not LocalPlayer.Character then return end
    local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local bv = hrp:FindFirstChild("BodyVelocity") or Instance.new("BodyVelocity")
    bv.Name = "BodyVelocity"
    bv.Velocity = Vector3.zero
    bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bv.Parent = hrp

    local dist = (hrp.Position - targetPos).Magnitude
    local time = dist / Config.Speed
    
    local tweenInfo = TweenInfo.new(time, Enum.EasingStyle.Linear)
    currentTween = TweenService:Create(hrp, tweenInfo, {CFrame = CFrame.new(targetPos)})
    currentTween:Play()
    return currentTween
end

-- // H√ÄM QU√âT R∆Ø∆†NG (CACHE) //
local function RefreshChestCache(centerPos)
    ChestCache = {} 
    ToggleBtn.Text = "üü° SCANNING ISLAND..." -- M√†u v√†ng b√°o ƒëang qu√©t
    ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 0)
    task.wait(0.2)
    
    for _, v in pairs(Workspace:GetDescendants()) do
        if (v.Name == "Chest" or v.Name == "R∆∞∆°ng" or string.find(v.Name, "Chest")) and (v:IsA("Part") or v:IsA("MeshPart")) then
            if not BlacklistedChests[v] and (v.Position - centerPos).Magnitude <= Config.IslandRadius then
                table.insert(ChestCache, v)
            end
        end
    end
    -- Tr·∫£ l·∫°i m√†u xanh
    if _G.AutoChestEnabled then
        ToggleBtn.Text = "üü¢ FARMING: " .. #ChestCache .. " CHESTS"
        ToggleBtn.TextColor3 = Color3.fromRGB(50, 255, 50)
    end
end

-- // V√íNG L·∫∂P CH√çNH //
task.spawn(function()
    while task.wait(0.1) do
        -- Ch·ªâ ch·∫°y logic khi bi·∫øn Enabled l√† TRUE
        if _G.AutoChestEnabled then
            pcall(function()
                local currentIsland = Islands[currentIslandIndex]
                if not currentIsland then
                    ToggleBtn.Text = "DONE ALL ISLANDS!"
                    _G.AutoChestEnabled = false
                    return
                end

                local char = LocalPlayer.Character
                if not char or not char:FindFirstChild("HumanoidRootPart") then return end
                local hrp = char.HumanoidRootPart

                -- 1. DI CHUY·ªÇN
                if isTraveling then
                    ToggleBtn.Text = "‚úàÔ∏è FLYING TO: " .. currentIsland.Name
                    local tw = TweenTo(currentIsland.Pos)
                    
                    if (hrp.Position - currentIsland.Pos).Magnitude < 150 then
                        if tw then tw:Cancel() end
                        isTraveling = false
                        RefreshChestCache(currentIsland.Pos)
                    end
                    return
                end

                -- 2. NH·∫∂T R∆Ø∆†NG
                local activeChests = {}
                for _, c in pairs(ChestCache) do
                    if c and c.Parent and not BlacklistedChests[c] then
                        table.insert(activeChests, c)
                    end
                end
                ChestCache = activeChests

                if #ChestCache > 0 then
                    -- T√¨m c√°i g·∫ßn nh·∫•t
                    local targetChest = nil
                    local minDst = math.huge
                    for _, c in pairs(ChestCache) do
                        local d = (hrp.Position - c.Position).Magnitude
                        if d < minDst then minDst = d; targetChest = c end
                    end
                    
                    if targetChest then
                        ToggleBtn.Text = "üü¢ COLLECTING: " .. currentIsland.Name .. " (" .. #ChestCache .. ")"
                        TweenTo(targetChest.Position)
                        
                        if (hrp.Position - targetChest.Position).Magnitude < Config.MinDistance then
                            hrp.CFrame = targetChest.CFrame
                            task.wait(Config.WaitTime)
                            
                            BlacklistedChests[targetChest] = true
                            targetChest.Transparency = 1
                            targetChest.CanCollide = false
                        end
                    end
                else
                    -- Chuy·ªÉn ƒë·∫£o
                    ToggleBtn.Text = "‚úÖ ISLAND CLEARED! NEXT..."
                    task.wait(0.5)
                    currentIslandIndex = currentIslandIndex + 1
                    isTraveling = true
                end
            end)
        else
            -- N·∫øu ƒëang t·∫Øt, v√≤ng l·∫∑p v·∫´n ch·∫°y nh∆∞ng kh√¥ng l√†m g√¨ (ch·ªù b·∫≠t l·∫°i)
        end
    end
end)
