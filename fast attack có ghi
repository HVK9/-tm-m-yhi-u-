--[[
    UI CONTROL FOR AUTO ATTACK
    Script đã được tích hợp UI Bật/Tắt theo yêu cầu.
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")

-- Kiểm tra an toàn các Folder game (để tránh lỗi nếu game update)
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")
local LocalPlayer = Players.LocalPlayer

-- Cấu hình gốc (Mặc định tắt để chờ bấm nút)
local COMBAT_CONFIG = {
    enabled = false, -- Mặc định là FALSE
    attacksPerTarget = 3,
    maxTargets = 5,
    baseRange = 100,
    minDelay = 0.05,
    maxDelay = 0.1,
    hitDelay = 0.02,
    randomization = {
        range = {min = -2, max = 2},
        timing = {min = -0.05, max = 0.05}
    }
}

--------------------------------------------------------------------------------
-- PHẦN LOGIC AUTO ATTACK (GIỮ NGUYÊN TỪ SCRIPT GỐC)
--------------------------------------------------------------------------------

local function GetPrimaryPart(model)
    return model:FindFirstChild("HumanoidRootPart") or model:FindFirstChild("PrimaryPart")
end

local function IsValidTarget(target)
    if not target then return false end
    local humanoid = target:FindFirstChildOfClass("Humanoid")
    if not humanoid or humanoid.Health <= 0 then return false end
    local targetPlayer = Players:GetPlayerFromCharacter(target)
    if targetPlayer and targetPlayer.Team == LocalPlayer.Team then return false end
    return true
end

local function GetNearbyTargets()
    local character = LocalPlayer.Character
    if not character or not character.PrimaryPart then return {} end
    
    local charPos = character.PrimaryPart.Position
    local targets = {}
    
    for _, folder in ipairs({workspace:FindFirstChild("Characters"), workspace:FindFirstChild("Enemies")}) do
        if folder then
            for _, entity in ipairs(folder:GetChildren()) do
                if entity ~= character and IsValidTarget(entity) then
                    local primaryPart = GetPrimaryPart(entity)
                    if primaryPart then
                        local distance = (primaryPart.Position - charPos).Magnitude
                        local range = COMBAT_CONFIG.baseRange + math.random(
                            COMBAT_CONFIG.randomization.range.min,
                            COMBAT_CONFIG.randomization.range.max
                        )
                        if distance <= range then
                            table.insert(targets, {
                                part = primaryPart,
                                distance = distance
                            })
                        end
                    end
                end
            end
        end
    end
    table.sort(targets, function(a, b) return a.distance < b.distance end)
    return targets
end

local function PerformAttackSequence(targets)
    if #targets == 0 then return end
    RegisterAttack:FireServer()
    for i = 1, math.min(#targets, COMBAT_CONFIG.maxTargets) do
        local target = targets[i]
        for _ = 1, COMBAT_CONFIG.attacksPerTarget do
            RegisterHit:FireServer(target.part)
            task.wait(COMBAT_CONFIG.hitDelay + math.random() * COMBAT_CONFIG.randomization.timing.max)
        end
    end
end

local lastAttackTime = 0
local function CombatLoop()
    if not COMBAT_CONFIG.enabled then return end -- Kiểm tra trạng thái bật/tắt
    
    local now = tick()
    local baseDelay = math.random(
        COMBAT_CONFIG.minDelay * 100,
        COMBAT_CONFIG.maxDelay * 100
    ) / 100
    
    if now - lastAttackTime >= baseDelay then
        local targets = GetNearbyTargets()
        PerformAttackSequence(targets)
        lastAttackTime = now
    end
end

-- Kết nối vòng lặp
local combatConnection
local function SetupCombat()
    if combatConnection then combatConnection:Disconnect() end
    combatConnection = RunService.Heartbeat:Connect(CombatLoop)
end

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(0.5)
    SetupCombat()
end)

SetupCombat()

--------------------------------------------------------------------------------
-- PHẦN GIAO DIỆN (UI)
--------------------------------------------------------------------------------

-- Xóa UI cũ nếu tồn tại
if _G.AutoAttackUI then _G.AutoAttackUI:Destroy() end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoAttackUI"
ScreenGui.ResetOnSpawn = false
-- Thử đưa vào CoreGui để an toàn, nếu không được thì đưa vào PlayerGui
pcall(function() ScreenGui.Parent = CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end
_G.AutoAttackUI = ScreenGui

-- Tạo khung chính (Button)
local MainButton = Instance.new("TextButton")
MainButton.Name = "MainButton"
MainButton.Parent = ScreenGui
MainButton.BackgroundColor3 = Color3.fromRGB(33, 37, 50) -- Màu xanh tối mặc định
MainButton.Position = UDim2.new(0.5, -125, 0.4, 0) -- Canh giữa màn hình
MainButton.Size = UDim2.new(0, 250, 0, 80)
MainButton.Font = Enum.Font.GothamBold
MainButton.Text = ""
MainButton.AutoButtonColor = false

-- Bo góc cho đẹp
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = MainButton

-- Icon Kiếm (Sử dụng Emoji cho tiện hoặc thay bằng ImageLabel nếu có ID)
local IconLabel = Instance.new("TextLabel")
IconLabel.Name = "Icon"
IconLabel.Parent = MainButton
IconLabel.BackgroundTransparency = 1
IconLabel.Position = UDim2.new(0.05, 0, 0.2, 0)
IconLabel.Size = UDim2.new(0, 40, 0, 40)
IconLabel.Font = Enum.Font.GothamBold
IconLabel.Text = "⚔️" -- Biểu tượng kiếm
IconLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
IconLabel.TextSize = 30
IconLabel.TextXAlignment = Enum.TextXAlignment.Center

-- Chữ Tiêu đề (BẬT/TẮT AUTO ATTACK)
local TitleLabel = Instance.new("TextLabel")
TitleLabel.Name = "Title"
TitleLabel.Parent = MainButton
TitleLabel.BackgroundTransparency = 1
TitleLabel.Position = UDim2.new(0.25, 0, 0.2, 0)
TitleLabel.Size = UDim2.new(0.7, 0, 0.3, 0)
TitleLabel.Font = Enum.Font.GothamBlack
TitleLabel.Text = "BẬT AUTO ATTACK"
TitleLabel.TextColor3 = Color3.fromRGB(100, 200, 255) -- Màu xanh nhạt
TitleLabel.TextSize = 18
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Chữ Trạng thái
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Name = "Status"
StatusLabel.Parent = MainButton
StatusLabel.BackgroundTransparency = 1
StatusLabel.Position = UDim2.new(0.25, 0, 0.55, 0)
StatusLabel.Size = UDim2.new(0.7, 0, 0.2, 0)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.Text = "Trạng thái: TẮT"
StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
StatusLabel.TextSize = 12
StatusLabel.TextTransparency = 0.3
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Chức năng kéo thả UI (Draggable)
local UserInputService = game:GetService("UserInputService")
local dragging, dragInput, dragStart, startPos
MainButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainButton.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
MainButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainButton.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Chức năng cập nhật giao diện khi bấm
local function UpdateUI()
    if COMBAT_CONFIG.enabled then
        -- Trạng thái ĐANG BẬT (Giống hình đỏ)
        MainButton.BackgroundColor3 = Color3.fromRGB(160, 50, 60) -- Màu đỏ
        TitleLabel.Text = "TẮT AUTO ATTACK"
        TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        StatusLabel.Text = "Trạng thái: ĐANG HOẠT ĐỘNG"
        StatusLabel.TextColor3 = Color3.fromRGB(150, 255, 150) -- Chữ xanh lá nhạt
    else
        -- Trạng thái ĐANG TẮT (Giống hình xanh)
        MainButton.BackgroundColor3 = Color3.fromRGB(33, 37, 50) -- Màu xanh tối
        TitleLabel.Text = "BẬT AUTO ATTACK"
        TitleLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
        StatusLabel.Text = "Trạng thái: TẮT"
        StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    end
end

-- Sự kiện Click
MainButton.MouseButton1Click:Connect(function()
    COMBAT_CONFIG.enabled = not COMBAT_CONFIG.enabled
    UpdateUI()
end)

-- Khởi tạo giao diện lần đầu
UpdateUI()
